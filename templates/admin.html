{% extends "base.html" %}

{% block sidebar %}
<div class="sidebar p-3">
    <h4 class="text-white text-center">Panel Admin</h4>
    <hr class="text-white-50">
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="{{ url_for('admin_dashboard') }}" class="nav-link text-white active">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
        </li>
        <li>
            <a href="{{ url_for('admin_abrir') }}" class="nav-link text-white" onclick="return confirm('Â¿EstÃ¡s seguro de que quieres abrir la puerta remotamente?');">
                <i class="bi bi-unlock-fill me-2"></i> Abrir Puerta
            </a>
        </li>
        <li class="nav-item mt-4">
            <h6 class="text-white-50">Herramientas</h6>
        </li>
        <li>
            <a class="nav-link text-white" data-bs-toggle="collapse" href="#collapseNuevoDocente" role="button">
                <i class="bi bi-person-plus-fill me-2"></i> Nuevo Docente
            </a>
        </li>
        <li>
            <a class="nav-link text-white" data-bs-toggle="collapse" href="#collapseReportes" role="button">
                <i class="bi bi-file-earmark-excel-fill me-2"></i> Reportes
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="collapse mb-4" id="collapseNuevoDocente">
    <div class="card shadow">
        <div class="card-header bg-success text-white">âž• Nuevo Docente</div>
        <div class="card-body">
            <form action="/crear_docente" method="POST">
                <div class="row">
                    <div class="col-md-6 mb-2"><input type="text" name="nombre" class="form-control" placeholder="Nombre Completo" required></div>
                    <div class="col-md-6 mb-2"><input type="number" name="bio_id" class="form-control" placeholder="ID BiomÃ©trico" required></div>
                    <div class="col-md-6 mb-2"><input type="text" name="username" class="form-control" placeholder="Usuario Login" required></div>
                    <div class="col-md-6 mb-2"><input type="password" name="password" class="form-control" placeholder="ContraseÃ±a" required></div>
                </div>
                <button class="btn btn-success w-100 mt-2">Registrar Docente</button>
            </form>
        </div>
    </div>
</div>

<div class="collapse mb-4" id="collapseReportes">
    <div class="card shadow">
        <div class="card-header bg-dark text-white">ðŸ“Š Reportes de Asistencia</div>
        <div class="card-body">
            <form action="/descargar_reporte" method="GET">
                <div class="row">
                    <div class="col-md-6"><label>Desde:</label><input type="date" name="fecha_inicio" class="form-control mb-2"></div>
                    <div class="col-md-6"><label>Hasta:</label><input type="date" name="fecha_fin" class="form-control mb-2"></div>
                    <div class="col-md-12"><label>Docente:</label>
                        <select name="docente_id" class="form-select mb-3">
                            <option value="todos">Todos</option>
                            {% for d in docentes %}<option value="{{ d.biometric_id }}">{{ d.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary w-100">ðŸ“¥ Descargar Excel</button>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <!-- Columna de Accesos y Logs -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-broadcast-pin me-2"></i> Accesos en Vivo</span>
                <div class="spinner-grow spinner-grow-sm" role="status" id="live-indicator">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nombre / ID</th>
                                <th>Evento</th>
                                <th>Origen</th>
                            </tr>
                        </thead>
                        <tbody id="live-logs-body">
                            <!-- Los logs se insertarÃ¡n aquÃ­ por JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Columna de Lista de Docentes -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-people-fill me-2"></i> Docentes</span>
                <span class="badge bg-primary rounded-pill">{{ docentes|length }}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>ID Bio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in docentes %}
                            <tr>
                                <td>{{ d.nombre }}</td>
                                <td>{{ d.biometric_id }}</td>
                                <td>
                                    <a href="{{ url_for('editar_docente', id=d.id) }}" class="btn btn-sm btn-outline-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                                    <a href="{{ url_for('eliminar_docente', id=d.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Â¿EstÃ¡s seguro?')" title="Eliminar"><i class="bi bi-trash"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logsBody = document.getElementById('live-logs-body');
        const liveIndicator = document.getElementById('live-indicator');
        let lastLogId = 0;

        async function fetchLogs() {
            try {
                liveIndicator.style.display = 'block';
                const response = await fetch('/api/logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const logs = await response.json();
                
                if (logs && logs.length > 0) {
                    const latestLogId = logs[0].id;
                    if (latestLogId !== lastLogId) {
                        updateTable(logs);
                        lastLogId = latestLogId;
                    }
                }
            } catch (error) {
                console.error("Could not fetch logs:", error);
                logsBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los logs.</td></tr>';
            } finally {
                setTimeout(() => { liveIndicator.style.display = 'none'; }, 500);
            }
        }

        function updateTable(logs) {
            logsBody.innerHTML = ''; // Limpiar tabla
            logs.forEach(log => {
                const isNew = log.id > lastLogId && lastLogId !== 0;
                let row = document.createElement('tr');
                if (isNew) {
                    row.classList.add('table-info'); // AnimaciÃ³n simple
                }

                let nombreCell = '';
                if (log.nombre) {
                    nombreCell = `<td><i class="bi bi-person-check-fill text-success me-2"></i>${log.nombre}</td>`;
                } else {
                    nombreCell = `<td><span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i> ID no registrado: ${log.usuario_id}</span></td>`;
                }

                let eventoCell = `<td><span class="badge bg-${log.tipo_evento.includes('ASISTENCIA') ? 'success' : 'warning'}">${log.tipo_evento}</span></td>`;

                row.innerHTML = `
                    <td>${log.fecha}</td>
                    ${nombreCell}
                    ${eventoCell}
                    <td>${log.origen}</td>
                `;
                logsBody.appendChild(row);
            });
        }

        // Carga inicial y luego cada 3 segundos
        fetchLogs();
        setInterval(fetchLogs, 3000);
    });
</script>
{% endblock %}