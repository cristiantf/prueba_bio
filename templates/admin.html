{% extends "base.html" %}

{% block sidebar %}
<div class="sidebar p-3">
    <h4 class="text-white text-center">Panel Admin</h4>
    <hr class="text-white-50">
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="{{ url_for('admin_dashboard') }}" class="nav-link text-white active">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
        </li>
        <li>
            <a href="{{ url_for('admin_abrir') }}" class="nav-link text-white" onclick="return confirm('Â¿EstÃ¡s seguro de que quieres abrir la puerta remotamente?');">
                <i class="bi bi-unlock-fill me-2"></i> Abrir Puerta
            </a>
        </li>
        <li class="nav-item mt-4">
            <h6 class="text-white-50">Herramientas</h6>
        </li>
        <li>
            <a class="nav-link text-white" data-bs-toggle="collapse" href="#collapseNuevoDocente" role="button">
                <i class="bi bi-person-plus-fill me-2"></i> Nuevo Docente
            </a>
        </li>
        <li>
            <a class="nav-link text-white" data-bs-toggle="collapse" href="#collapseReportes" role="button">
                <i class="bi bi-file-earmark-excel-fill me-2"></i> Reportes
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="collapse mb-4" id="collapseNuevoDocente">
    <div class="card shadow border-0">
        <div class="card-header bg-success text-white fw-bold">âž• Registrar Nuevo Docente</div>
        <div class="card-body">
            <form action="/crear_docente" method="POST">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" name="nombre" class="form-control" required placeholder="Ej. Juan PÃ©rez">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ID BiomÃ©trico</label>
                        <input type="number" name="bio_id" class="form-control" required placeholder="Ej. 101">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Usuario Login</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ContraseÃ±a</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    
                    <div class="col-12 mt-3">
                        <div class="d-flex justify-content-between align-items-center p-3 border rounded bg-light">
                            <div>
                                <label class="fw-bold mb-0" for="permisoNew"><i class="bi bi-key-fill text-warning me-2"></i>Permiso de Puerta</label>
                                <div class="small text-muted">Si se activa, este usuario podrÃ¡ abrir la puerta con su huella.</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="acceso_puerta" id="permisoNew" style="transform: scale(1.3); cursor: pointer;">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success w-100 mt-4 py-2 fw-bold">Guardar Docente</button>
            </form>
        </div>
    </div>
</div>

<div class="collapse mb-4" id="collapseReportes">
    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white fw-bold">ðŸ“Š Generar Reportes</div>
        <div class="card-body">
            <form action="/descargar_reporte_matricial" method="GET">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Desde:</label><input type="date" name="fecha_inicio" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Hasta:</label><input type="date" name="fecha_fin" class="form-control"></div>
                    <div class="col-md-12"><label class="form-label">Docente:</label>
                        <select name="docente_id" class="form-select">
                            <option value="todos">Todos los docentes</option>
                            {% for d in docentes %}<option value="{{ d.biometric_id }}">{{ d.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary w-100 mt-3"><i class="bi bi-download me-2"></i>Descargar Excel (Doble Jornada)</button>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow border-0 mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span class="fw-bold"><i class="bi bi-broadcast-pin me-2"></i> Monitor en Vivo</span>
                <div class="spinner-grow spinner-grow-sm text-light" role="status" id="live-indicator"></div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 450px;">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Hora</th>
                                <th>Usuario</th>
                                <th>Evento</th>
                                <th>Origen</th>
                            </tr>
                        </thead>
                        <tbody id="live-logs-body" class="align-middle">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card shadow border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
                <span class="fw-bold text-primary"><i class="bi bi-people-fill me-2"></i> Lista de Docentes</span>
                <span class="badge bg-primary rounded-pill">{{ docentes|length }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 450px;">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 45%;">Nombre</th>
                                <th class="text-center">Puerta</th>
                                <th class="text-end pe-3">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in docentes %}
                            <tr>
                                <td class="ps-3">
                                    <div class="fw-bold text-dark">{{ d.nombre }}</div>
                                    <small class="text-muted"><i class="bi bi-fingerprint me-1"></i>ID: {{ d.biometric_id }}</small>
                                </td>
                                <td class="text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input shadow-none" type="checkbox" role="switch" 
                                               onchange="togglePermiso({{ d.id }}, this)" 
                                               style="transform: scale(1.2); cursor: pointer;"
                                               {% if d.acceso_puerta == 1 %}checked{% endif %}>
                                    </div>
                                </td>
                                <td class="text-end pe-3">
                                    <div class="btn-group">
                                        <a href="{{ url_for('editar_docente', id=d.id) }}" class="btn btn-sm btn-outline-secondary border-0"><i class="bi bi-pencil-square fs-6"></i></a>
                                        <a href="{{ url_for('eliminar_docente', id=d.id) }}" class="btn btn-sm btn-outline-danger border-0" onclick="return confirm('Â¿Eliminar a {{ d.nombre }}?')"><i class="bi bi-trash fs-6"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function togglePermiso(id, checkbox) {
        // AnimaciÃ³n visual inmediata (feedback)
        const originalState = !checkbox.checked;
        try {
            const response = await fetch(`/toggle_permiso/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: checkbox.checked })
            });
            const data = await response.json();
            if(!data.success) {
                alert("No se pudo guardar el cambio.");
                checkbox.checked = originalState;
            }
        } catch (e) {
            console.error(e);
            checkbox.checked = originalState;
            alert("Error de conexiÃ³n con el servidor.");
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const logsBody = document.getElementById('live-logs-body');
        const liveIndicator = document.getElementById('live-indicator');
        let lastLogId = 0;

        async function fetchLogs() {
            try {
                liveIndicator.style.opacity = '1';
                const response = await fetch('/api/logs');
                if (!response.ok) throw new Error("Error HTTP");
                const logs = await response.json();
                
                if (logs && logs.length > 0) {
                    if (logs[0].id !== lastLogId) {
                        updateTable(logs);
                        lastLogId = logs[0].id;
                    }
                }
            } catch (e) { console.error(e); } 
            finally { 
                setTimeout(() => { liveIndicator.style.opacity = '0.2'; }, 500); 
            }
        }

        function updateTable(logs) {
            logsBody.innerHTML = ''; 
            logs.forEach(log => {
                let row = document.createElement('tr');
                if (log.id > lastLogId && lastLogId !== 0) row.classList.add('table-primary');
                
                // Formatear hora (solo hora, sin fecha para ahorrar espacio)
                let hora = log.fecha.split(' ')[1]; 
                
                let nombre = log.nombre 
                    ? `<span class="fw-semibold text-dark">${log.nombre}</span>` 
                    : `<span class="badge bg-danger">ID: ${log.usuario_id}</span>`;

                let badge = log.tipo_evento.includes('ASISTENCIA') ? 'success' : 'warning text-dark';
                let evento = `<span class="badge bg-${badge} border border-${badge} bg-opacity-25 text-${badge === 'success' ? 'success' : 'dark'}">${log.tipo_evento}</span>`;

                row.innerHTML = `
                    <td class="text-muted"><small>${hora}</small></td>
                    <td>${nombre}</td>
                    <td>${evento}</td>
                    <td><small class="text-secondary">${log.origen}</small></td>
                `;
                logsBody.appendChild(row);
            });
        }

        fetchLogs();
        setInterval(fetchLogs, 3000);
    });
</script>
{% endblock %}