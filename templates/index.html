<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Acceso | Tesis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-header { background-color: #0d6efd; color: white; }
        .btn-puerta { height: 100px; font-size: 1.5rem; width: 100%; }
        .log-container { max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="text-center mb-4">Sistema de GestiÃ³n BiometrÃ­ca</h1>
    
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="m-0">Control Manual</h5>
                </div>
                <div class="card-body text-center">
                    <p class="text-muted">Presiona para abrir la puerta remotamente.</p>
                    <button id="btnAbrir" class="btn btn-danger btn-puerta" onclick="abrirPuerta()">
                        ðŸ”“ ABRIR PUERTA
                    </button>
                    <div id="mensajeEstado" class="mt-3 fw-bold"></div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Registros en Tiempo Real</h5>
                    <span class="badge bg-light text-dark">ðŸ”´ En Vivo</span>
                </div>
                <div class="card-body log-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Evento</th>
                                <th>Origen</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuerpo">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // FunciÃ³n para abrir la puerta
    async function abrirPuerta() {
        const btn = document.getElementById('btnAbrir');
        const msg = document.getElementById('mensajeEstado');
        
        btn.disabled = true;
        btn.innerText = "â³ Enviando comando...";
        
        try {
            const res = await fetch('/api/abrir_puerta', { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                msg.innerText = "âœ… " + data.message;
                msg.className = "mt-3 fw-bold text-success";
            } else {
                msg.innerText = "âŒ " + data.message;
                msg.className = "mt-3 fw-bold text-danger";
            }
        } catch (error) {
            msg.innerText = "âŒ Error de conexiÃ³n con el servidor";
        }

        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = "ðŸ”“ ABRIR PUERTA";
            msg.innerText = "";
        }, 3000);
    }

    // FunciÃ³n para actualizar la tabla automÃ¡ticamente
    async function actualizarTabla() {
        try {
            const res = await fetch('/api/historial');
            const data = await res.json();
            
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = ""; // Limpiar tabla

            data.forEach(log => {
                let color = "text-dark";
                if(log.tipo_evento.includes("APERTURA")) color = "text-danger fw-bold";
                if(log.tipo_evento.includes("ASISTENCIA")) color = "text-success fw-bold";

                const row = `
                    <tr>
                        <td>${log.id}</td>
                        <td>${log.fecha}</td>
                        <td class="fw-bold">${log.usuario_id}</td>
                        <td class="${color}">${log.tipo_evento}</td>
                        <td>${log.origen}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (e) {
            console.error("Error actualizando tabla:", e);
        }
    }

    // Actualizar cada 2 segundos
    setInterval(actualizarTabla, 2000);
    actualizarTabla(); // Cargar al inicio
</script>

</body>
</html>